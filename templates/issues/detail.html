{% extends "base.html" %}
{% load core_tags %}

{% block title %}{{ issue.title }}{% endblock %}
{% block page_title %}Issue Detail{% endblock %}
{% block page_subtitle %}{{ issue.title|truncatewords:8 }}{% endblock %}

{% block content %}
<div class="fade-in space-y-6">

    <!-- Action Bar -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <a href="{% url 'issue_list' %}" class="inline-flex items-center text-sm text-gray-500 hover:text-primary-600 font-medium transition">
            <i class="fas fa-arrow-left mr-2"></i> Back to Issues
        </a>
        <div class="flex items-center gap-2 flex-wrap">
            <!-- Trash -->
            <form method="post" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="trash">
                <button type="submit" class="px-3 py-2 rounded-xl border border-gray-200 text-sm text-orange-500 hover:bg-orange-50 hover:border-orange-200 transition" title="Move to Trash">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </form>
            <!-- Delete -->
            <form method="post" class="inline" onsubmit="return confirm('Permanently delete this issue? This action cannot be undone.');">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <button type="submit" class="px-3 py-2 rounded-xl border border-red-200 text-sm text-red-500 hover:bg-red-50 transition" title="Delete Permanently">
                    <i class="fas fa-times-circle"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Two-Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- ===== Main Content (Left) ===== -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Title & Description (Editable) -->
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <div class="glass-card rounded-2xl p-5 lg:p-6 space-y-4">
                    <!-- Title -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Title</label>
                        <input type="text" name="title" value="{{ issue.title }}"
                               class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-semibold text-gray-800 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Description</label>
                        <textarea name="description" rows="5"
                                  class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition resize-y">{{ issue.description }}</textarea>
                    </div>

                    <!-- Inline update fields -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 pt-2">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Status</label>
                            <select name="status" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                {% for val, label in status_choices %}
                                <option value="{{ val }}" {% if issue.status == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Priority</label>
                            <select name="priority" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                {% for val, label in priority_choices %}
                                <option value="{{ val }}" {% if issue.priority == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Due Date</label>
                            <input type="datetime-local" name="start_date"
                                   value="{% if issue.start_date %}{{ issue.start_date|date:'Y-m-d\TH:i' }}{% endif %}"
                                   class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Outlet</label>
                            <select name="outlet" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                <option value="">— None —</option>
                                {% for o in outlets %}
                                <option value="{{ o.id }}" {% if issue.outlet_id == o.id %}selected{% endif %}>{{ o.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Team</label>
                            <select name="team" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                <option value="">— None —</option>
                                {% for t in teams %}
                                <option value="{{ t.id }}" {% if issue.team_id == t.id %}selected{% endif %}>{{ t.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">
                            <i class="fas fa-tag mr-1 text-indigo-400"></i> Tags
                        </label>
                        <input type="text" name="tags" value="{{ issue.tags }}" placeholder="Space-separated tags"
                               class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                    </div>

                    <!-- Assigned To -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Assigned To</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-1">
                            {% for m in members %}
                            <label class="flex items-center gap-2.5 p-2 rounded-xl border border-gray-100 hover:border-primary-200 hover:bg-primary-50/30 cursor-pointer transition">
                                <input type="checkbox" name="assigned_to" value="{{ m.id }}"
                                       {% if m in issue.assigned_to.all %}checked{% endif %}
                                       class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                                <div class="w-7 h-7 rounded-full flex items-center justify-center text-white text-[10px] font-bold flex-shrink-0" style="background-color: {{ m.avatar_color }}">
                                    {{ m.initials }}
                                </div>
                                <span class="text-xs text-gray-700 font-medium truncate">{{ m.full_name }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="submit" class="px-5 py-2.5 bg-gradient-to-r from-primary-600 to-purple-600 text-white text-sm font-semibold rounded-xl hover:shadow-lg hover:shadow-primary-500/25 transition-all hover:-translate-y-0.5">
                            <i class="fas fa-save mr-2"></i> Update Issue
                        </button>
                    </div>
                </div>
            </form>

            <!-- Comments -->
            <div class="glass-card rounded-2xl p-5 lg:p-6">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-comments text-indigo-500 text-sm"></i>
                    </div>
                    <h3 class="text-sm font-bold text-gray-800">Comments</h3>
                    {% if comments %}
                    <span class="text-xs text-gray-400">({{ comments|length }})</span>
                    {% endif %}
                </div>

                <!-- Comment Form -->
                <form method="post" class="mb-5">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="comment">
                    <textarea name="comment" rows="3" placeholder="Write a comment..." required
                              class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition resize-y mb-2"></textarea>
                    <div class="flex justify-end">
                        <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-semibold rounded-xl hover:bg-primary-700 transition">
                            <i class="fas fa-paper-plane mr-1.5"></i> Post Comment
                        </button>
                    </div>
                </form>

                <!-- Comment List -->
                {% if comments %}
                <div class="space-y-4">
                    {% for c in comments %}
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0 mt-0.5"
                             style="background-color: {% if c.user %}{{ c.user.avatar_color }}{% else %}#6b7280{% endif %}">
                            {% if c.user %}{{ c.user.initials }}{% else %}?{% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm font-semibold text-gray-800">
                                    {% if c.user %}{{ c.user.full_name }}{% else %}Unknown{% endif %}
                                </span>
                                <span class="text-[10px] text-gray-400">{{ c.created_at|timesince }} ago</span>
                            </div>
                            <p class="text-sm text-gray-600 whitespace-pre-line">{{ c.comment }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-gray-400 text-center py-4">
                    <i class="fas fa-comment-slash mr-1"></i> No comments yet. Be the first!
                </p>
                {% endif %}
            </div>

        </div>

        <!-- ===== Sidebar (Right) ===== -->
        <div class="space-y-5">

            <!-- Status Overview Card -->
            <div class="glass-card rounded-2xl p-5 space-y-4">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Issue Info</h3>

                <!-- Status -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-circle text-[8px] mr-1.5" style="color:{{ issue.status_color }}"></i> Status</span>
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold {{ issue.status|status_badge_class }}">
                        {{ issue.get_status_display }}
                    </span>
                </div>

                <!-- Priority -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-flag mr-1.5"></i> Priority</span>
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold {{ issue.priority|priority_badge_class }}">
                        {{ issue.get_priority_display }}
                    </span>
                </div>

                <hr class="border-gray-100">

                <!-- Outlet -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-store mr-1.5"></i> Outlet</span>
                    <span class="text-xs text-gray-700 font-medium">
                        {% if issue.outlet %}{{ issue.outlet.name }}{% else %}—{% endif %}
                    </span>
                </div>

                <!-- Team -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-people-arrows mr-1.5"></i> Team</span>
                    <span class="text-xs text-gray-700 font-medium">
                        {% if issue.team %}{{ issue.team.name }}{% else %}—{% endif %}
                    </span>
                </div>

                <hr class="border-gray-100">

                <!-- Due Date -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-calendar mr-1.5"></i> Due Date</span>
                    <span class="text-xs text-gray-700 font-medium">
                        {% if issue.start_date %}{{ issue.start_date|date:"M d, Y H:i" }}{% else %}—{% endif %}
                    </span>
                </div>

                <!-- Resolved At -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-check-circle mr-1.5 text-green-500"></i> Resolved At</span>
                    <span class="text-xs text-gray-700 font-medium">
                        {% if issue.resolved_at %}{{ issue.resolved_at|date:"M d, Y H:i" }}{% else %}—{% endif %}
                    </span>
                </div>

                <!-- Created -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-clock mr-1.5"></i> Created</span>
                    <span class="text-xs text-gray-500">{{ issue.created_at|date:"M d, Y" }}</span>
                </div>

                <!-- Tags -->
                {% if issue.tags %}
                <hr class="border-gray-100">
                <div>
                    <span class="text-xs text-gray-500 font-medium block mb-2"><i class="fas fa-tag mr-1.5"></i> Tags</span>
                    <div class="flex flex-wrap gap-1.5">
                        {% for tag in issue.tags.split %}
                        <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md font-semibold">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Assigned To -->
            <div class="glass-card rounded-2xl p-5">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Assigned To</h3>
                {% for person in issue.assignee_list %}
                <div class="flex items-center gap-2.5 {% if not forloop.last %}mb-2.5{% endif %}">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background-color: {{ person.avatar_color }}">
                        {{ person.initials }}
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">{{ person.full_name }}</p>
                        <p class="text-[10px] text-gray-400">{{ person.designation|default:"Member" }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-xs text-gray-400 text-center py-3">
                    <i class="fas fa-user-slash mr-1"></i> No one assigned
                </p>
                {% endfor %}
            </div>

            <!-- Created By -->
            {% if issue.created_by %}
            <div class="glass-card rounded-2xl p-5">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Reported By</h3>
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background-color: {{ issue.created_by.avatar_color }}">
                        {{ issue.created_by.initials }}
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">{{ issue.created_by.full_name }}</p>
                        <p class="text-[10px] text-gray-400">{{ issue.created_at|date:"M d, Y \a\t H:i" }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

    </div>

</div>
{% endblock %}
