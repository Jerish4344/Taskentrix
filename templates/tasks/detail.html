{% extends "base.html" %}
{% load core_tags %}

{% block title %}{{ task.title }}{% endblock %}
{% block page_title %}Task Detail{% endblock %}
{% block page_subtitle %}{{ task.title|truncatewords:8 }}{% endblock %}

{% block content %}
<div class="fade-in space-y-6">

    <!-- Action Bar -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <a href="{% url 'task_list' %}" class="inline-flex items-center text-sm text-gray-500 hover:text-primary-600 font-medium transition">
            <i class="fas fa-arrow-left mr-2"></i> Back to Tasks
        </a>
        <div class="flex items-center gap-2 flex-wrap">
            <!-- Star Toggle -->
            <form method="post" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="star">
                <button type="submit" class="px-3 py-2 rounded-xl border border-gray-200 text-sm hover:bg-yellow-50 transition {% if task.is_starred %}text-yellow-400 bg-yellow-50 border-yellow-200{% else %}text-gray-400{% endif %}" title="Toggle Star">
                    <i class="{% if task.is_starred %}fas{% else %}far{% endif %} fa-star"></i>
                </button>
            </form>
            <!-- AI Summary -->
            <form method="post" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="ai_summary">
                <button type="submit" class="px-3 py-2 rounded-xl border border-gray-200 text-sm text-purple-500 hover:bg-purple-50 hover:border-purple-200 transition" title="Generate AI Summary">
                    <i class="fas fa-robot mr-1"></i> AI
                </button>
            </form>
            <!-- Trash -->
            <form method="post" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="trash">
                <button type="submit" class="px-3 py-2 rounded-xl border border-gray-200 text-sm text-orange-500 hover:bg-orange-50 hover:border-orange-200 transition" title="Move to Trash">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </form>
            <!-- Delete -->
            <form method="post" class="inline" onsubmit="return confirm('Permanently delete this task? This action cannot be undone.');">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <button type="submit" class="px-3 py-2 rounded-xl border border-red-200 text-sm text-red-500 hover:bg-red-50 transition" title="Delete Permanently">
                    <i class="fas fa-times-circle"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Two-Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- ===== Main Content (Left) ===== -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Title & Description (Editable) -->
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <div class="glass-card rounded-2xl p-5 lg:p-6 space-y-4">
                    <!-- Title -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Title</label>
                        <input type="text" name="title" value="{{ task.title }}"
                               class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-semibold text-gray-800 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Description</label>
                        <textarea name="description" rows="4"
                                  class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition resize-y">{{ task.description }}</textarea>
                    </div>

                    <!-- SOP Content -->
                    {% if task.sop_content %}
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">
                            <i class="fas fa-book mr-1 text-purple-400"></i> SOP / Instructions
                        </label>
                        <div class="bg-purple-50/50 border border-purple-100 rounded-xl p-4 text-sm text-gray-700 whitespace-pre-line">{{ task.sop_content }}</div>
                    </div>
                    {% endif %}

                    <!-- Inline update fields: Status, Priority, Assignment -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 pt-2">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Status</label>
                            <select name="status" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                {% for val, label in status_choices %}
                                <option value="{{ val }}" {% if task.status == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Priority</label>
                            <select name="priority" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                {% for val, label in priority_choices %}
                                <option value="{{ val }}" {% if task.priority == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Due Date</label>
                            <input type="datetime-local" name="due_date"
                                   value="{% if task.due_date %}{{ task.due_date|date:'Y-m-d\TH:i' }}{% endif %}"
                                   class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Category</label>
                            <select name="category" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                <option value="">— None —</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if task.category_id == cat.id %}selected{% endif %}>{{ cat.icon }} {{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Project</label>
                            <select name="project" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                <option value="">— None —</option>
                                {% for proj in projects %}
                                <option value="{{ proj.id }}" {% if task.project_id == proj.id %}selected{% endif %}>{{ proj.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Points</label>
                            <input type="number" name="points" value="{{ task.points }}" min="0"
                                   class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Outlet</label>
                            <select name="outlet" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                <option value="">— None —</option>
                                {% for o in outlets %}
                                <option value="{{ o.id }}" {% if task.outlet_id == o.id %}selected{% endif %}>{{ o.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Team</label>
                            <select name="team" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                <option value="">— None —</option>
                                {% for t in teams %}
                                <option value="{{ t.id }}" {% if task.team_id == t.id %}selected{% endif %}>{{ t.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Assigned To -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Assigned To</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-1">
                            {% for m in members %}
                            <label class="flex items-center gap-2.5 p-2 rounded-xl border border-gray-100 hover:border-primary-200 hover:bg-primary-50/30 cursor-pointer transition">
                                <input type="checkbox" name="assigned_to" value="{{ m.id }}"
                                       {% if m in task.assigned_to.all %}checked{% endif %}
                                       class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                                <div class="w-7 h-7 rounded-full flex items-center justify-center text-white text-[10px] font-bold flex-shrink-0" style="background-color: {{ m.avatar_color }}">
                                    {{ m.initials }}
                                </div>
                                <span class="text-xs text-gray-700 font-medium truncate">{{ m.full_name }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="submit" class="px-5 py-2.5 bg-gradient-to-r from-primary-600 to-purple-600 text-white text-sm font-semibold rounded-xl hover:shadow-lg hover:shadow-primary-500/25 transition-all hover:-translate-y-0.5">
                            <i class="fas fa-save mr-2"></i> Update Task
                        </button>
                    </div>
                </div>
            </form>

            <!-- Steps Checklist -->
            <div class="glass-card rounded-2xl p-5 lg:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-orange-50 rounded-lg flex items-center justify-center">
                            <i class="fas fa-tasks text-orange-500 text-sm"></i>
                        </div>
                        <h3 class="text-sm font-bold text-gray-800">Steps</h3>
                        {% if steps %}
                        <span class="text-xs text-gray-400">({{ steps|length }})</span>
                        {% endif %}
                    </div>
                </div>

                {% if steps %}
                <div class="space-y-1.5">
                    {% for step in steps %}
                    <form method="post" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-gray-50 transition group">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="toggle_step">
                        <input type="hidden" name="step_id" value="{{ step.id }}">
                        <button type="submit" class="flex-shrink-0 w-5 h-5 rounded-md border-2 flex items-center justify-center transition
                            {% if step.is_completed %}bg-green-500 border-green-500 text-white{% else %}border-gray-300 hover:border-primary-400{% endif %}">
                            {% if step.is_completed %}<i class="fas fa-check text-[10px]"></i>{% endif %}
                        </button>
                        <span class="text-sm {% if step.is_completed %}line-through text-gray-400{% else %}text-gray-700{% endif %} flex-1">
                            {{ step.title }}
                        </span>
                        {% if step.completed_by %}
                        <span class="text-[10px] text-gray-400 hidden group-hover:inline">{{ step.completed_by.full_name }}</span>
                        {% endif %}
                    </form>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-gray-400 text-center py-4">
                    <i class="fas fa-check-circle mr-1"></i> No steps defined
                </p>
                {% endif %}

                <!-- Add Step -->
                <form method="post" class="mt-3 flex items-center gap-2">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_step">
                    <input type="text" name="step_title" placeholder="Add a new step..."
                           class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                    <button type="submit" class="px-3 py-2 bg-primary-50 text-primary-700 rounded-xl text-sm font-semibold hover:bg-primary-100 transition">
                        <i class="fas fa-plus"></i>
                    </button>
                </form>
            </div>

            <!-- Subtasks -->
            <div class="glass-card rounded-2xl p-5 lg:p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center">
                            <i class="fas fa-sitemap text-blue-500 text-sm"></i>
                        </div>
                        <h3 class="text-sm font-bold text-gray-800">Subtasks</h3>
                        {% if subtasks %}
                        <span class="text-xs text-gray-400">({{ subtasks|length }})</span>
                        {% endif %}
                    </div>
                </div>

                {% if subtasks %}
                <div class="space-y-2">
                    {% for sub in subtasks %}
                    <a href="{% url 'task_detail' sub.id %}" class="flex items-center justify-between p-3 rounded-xl border border-gray-100 hover:border-primary-200 hover:bg-primary-50/30 transition group">
                        <div class="flex items-center gap-3">
                            <span class="w-2 h-2 rounded-full" style="background-color: {{ sub.status_color }}"></span>
                            <span class="text-sm text-gray-700 font-medium group-hover:text-primary-700 transition">{{ sub.title }}</span>
                        </div>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold {{ sub.status|status_badge_class }}">
                            {{ sub.get_status_display }}
                        </span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-gray-400 text-center py-4">
                    <i class="fas fa-sitemap mr-1"></i> No subtasks yet
                </p>
                {% endif %}

                <!-- Add Subtask -->
                <form method="post" class="mt-3 flex items-center gap-2">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_subtask">
                    <input type="text" name="subtask_title" placeholder="Add a subtask..."
                           class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                    <button type="submit" class="px-3 py-2 bg-blue-50 text-blue-700 rounded-xl text-sm font-semibold hover:bg-blue-100 transition">
                        <i class="fas fa-plus"></i>
                    </button>
                </form>
            </div>

            <!-- Comments -->
            <div class="glass-card rounded-2xl p-5 lg:p-6">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center">
                        <i class="fas fa-comments text-indigo-500 text-sm"></i>
                    </div>
                    <h3 class="text-sm font-bold text-gray-800">Comments</h3>
                    {% if comments %}
                    <span class="text-xs text-gray-400">({{ comments|length }})</span>
                    {% endif %}
                </div>

                <!-- Comment Form -->
                <form method="post" class="mb-5">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="comment">
                    <textarea name="comment" rows="3" placeholder="Write a comment..." required
                              class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition resize-y mb-2"></textarea>
                    <div class="flex justify-end">
                        <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-semibold rounded-xl hover:bg-primary-700 transition">
                            <i class="fas fa-paper-plane mr-1.5"></i> Post Comment
                        </button>
                    </div>
                </form>

                <!-- Comment List -->
                {% if comments %}
                <div class="space-y-4">
                    {% for c in comments %}
                    <div class="flex gap-3 {% if c.is_ai_generated %}bg-purple-50/50 border border-purple-100 rounded-xl p-3{% endif %}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0 mt-0.5"
                             style="background-color: {% if c.is_ai_generated %}#a855f7{% elif c.user %}{{ c.user.avatar_color }}{% else %}#6b7280{% endif %}">
                            {% if c.is_ai_generated %}
                            <i class="fas fa-robot text-[10px]"></i>
                            {% elif c.user %}
                            {{ c.user.initials }}
                            {% else %}?{% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm font-semibold text-gray-800">
                                    {% if c.is_ai_generated %}AI Assistant{% elif c.user %}{{ c.user.full_name }}{% else %}Unknown{% endif %}
                                </span>
                                <span class="text-[10px] text-gray-400">{{ c.created_at|timesince }} ago</span>
                            </div>
                            <p class="text-sm text-gray-600 whitespace-pre-line">{{ c.comment }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-gray-400 text-center py-4">
                    <i class="fas fa-comment-slash mr-1"></i> No comments yet. Be the first!
                </p>
                {% endif %}
            </div>

        </div>

        <!-- ===== Sidebar (Right) ===== -->
        <div class="space-y-5">

            <!-- Status Overview Card -->
            <div class="glass-card rounded-2xl p-5 space-y-4">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Task Info</h3>

                <!-- Status -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-circle text-[8px] mr-1.5" style="color:{{ task.status_color }}"></i> Status</span>
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold {{ task.status|status_badge_class }}">
                        {{ task.get_status_display }}
                    </span>
                </div>

                <!-- Priority -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-flag mr-1.5"></i> Priority</span>
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold {{ task.priority|priority_badge_class }}">
                        {{ task.get_priority_display }}
                    </span>
                </div>

                <hr class="border-gray-100">

                <!-- Category -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-folder mr-1.5"></i> Category</span>
                    <span class="text-xs text-gray-700 font-medium">
                        {% if task.category %}{{ task.category.icon }} {{ task.category.name }}{% else %}—{% endif %}
                    </span>
                </div>

                <!-- Project -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-project-diagram mr-1.5"></i> Project</span>
                    <span class="text-xs text-gray-700 font-medium">
                        {% if task.project %}{{ task.project.name }}{% else %}—{% endif %}
                    </span>
                </div>

                <!-- Outlet -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-store mr-1.5"></i> Outlet</span>
                    <span class="text-xs text-gray-700 font-medium">
                        {% if task.outlet %}{{ task.outlet.name }}{% else %}—{% endif %}
                    </span>
                </div>

                <!-- Team -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-people-arrows mr-1.5"></i> Team</span>
                    <span class="text-xs text-gray-700 font-medium">
                        {% if task.team %}{{ task.team.name }}{% else %}—{% endif %}
                    </span>
                </div>

                <hr class="border-gray-100">

                <!-- Due Date -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-calendar mr-1.5"></i> Due Date</span>
                    <span class="text-xs font-medium {% if task.is_overdue %}text-red-600{% else %}text-gray-700{% endif %}">
                        {% if task.due_date %}{{ task.due_date|date:"M d, Y H:i" }}{% else %}—{% endif %}
                    </span>
                </div>

                <!-- Points -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-star mr-1.5 text-yellow-400"></i> Points</span>
                    <span class="text-xs text-gray-700 font-bold">{{ task.points }}</span>
                </div>

                <!-- Created -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-clock mr-1.5"></i> Created</span>
                    <span class="text-xs text-gray-500">{{ task.created_at|date:"M d, Y" }}</span>
                </div>

                {% if task.completed_at %}
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 font-medium"><i class="fas fa-check-circle mr-1.5 text-green-500"></i> Completed</span>
                    <span class="text-xs text-gray-500">{{ task.completed_at|date:"M d, Y" }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Assigned To -->
            <div class="glass-card rounded-2xl p-5">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Assigned To</h3>
                {% for person in task.assignee_list %}
                <div class="flex items-center gap-2.5 {% if not forloop.last %}mb-2.5{% endif %}">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background-color: {{ person.avatar_color }}">
                        {{ person.initials }}
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">{{ person.full_name }}</p>
                        <p class="text-[10px] text-gray-400">{{ person.designation|default:"Member" }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-xs text-gray-400 text-center py-3">
                    <i class="fas fa-user-slash mr-1"></i> No one assigned
                </p>
                {% endfor %}
            </div>

            <!-- AI Summary -->
            {% if task.ai_summary %}
            <div class="glass-card rounded-2xl p-5 border border-purple-100 bg-gradient-to-br from-purple-50/50 to-white">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-7 h-7 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <h3 class="text-xs font-semibold text-purple-700 uppercase tracking-wider">AI Summary</h3>
                </div>
                <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-line">{{ task.ai_summary }}</p>
                {% if task.ai_priority_suggestion %}
                <div class="mt-3 pt-3 border-t border-purple-100">
                    <p class="text-xs text-purple-600">
                        <i class="fas fa-lightbulb mr-1"></i>
                        Suggested Priority: <span class="font-bold capitalize">{{ task.ai_priority_suggestion }}</span>
                    </p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Created By -->
            {% if task.created_by %}
            <div class="glass-card rounded-2xl p-5">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Created By</h3>
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background-color: {{ task.created_by.avatar_color }}">
                        {{ task.created_by.initials }}
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">{{ task.created_by.full_name }}</p>
                        <p class="text-[10px] text-gray-400">{{ task.created_at|date:"M d, Y \a\t H:i" }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

    </div>

</div>
{% endblock %}
